apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: fluent-bit
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  destination:
    server: "https://kubernetes.default.svc"
    namespace: kube-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - PruneLast=true
    - ServerSideApply=true
    - ApplyOutOfSyncOnly=true
  source:
    chart: fluent-bit
    repoURL: https://fluent.github.io/helm-charts
    targetRevision: 0.49.1
    helm:
      releaseName: fluent-bit
      valuesObject:
        rbac:
          create: true
          nodeAccess: true
          eventsAccess: true
        serviceMonitor:
          enabled: true
          selector:
            release: prom
        prometheusRule:
          enabled: true
          additionalLabels:
            release: prom
          rules:
          - alert: NoOutputBytesProcessed
            expr: rate(fluentbit_output_proc_bytes_total[5m]) == 0
            annotations:
              message: |
                Fluent Bit instance {{ $labels.instance }}'s output plugin {{ $labels.name }} has not processed any
                bytes for at least 15 minutes.
              summary: No Output Bytes Processed
            for: 15m
        autoscaling:
          enabled: true
          vpa:
            enabled: true
        podAnnotations:
          fluentbit.io/exclude: "true"
        config:
          inputs: |
            [INPUT]
                Name tail
                Path /var/log/containers/*.log
                multiline.parser cri
                Tag kube.*
                Mem_Buf_Limit 8MB
                Skip_Long_Lines On
            [INPUT]
                Name systemd
                Tag host.*
                Systemd_Filter _SYSTEMD_UNIT=kubelet.service
                Read_From_Tail On
          customParsers: |
            [PARSER]
                Name        k8s_json
                Format      json
                Time_Key    timestamp
                Time_Format %Y-%m-%dT%H:%M:%S.%L
                Time_Keep   On
                Decode_Field_As escaped_utf8 message do_next
                Decode_Field_As json message
            
            [PARSER]
                Name        k8s_logfmt
                Format      logfmt
                Time_Key    ts
                Time_Format %Y-%m-%dT%H:%M:%S.%L
                Time_Keep   On

            [PARSER]
                Name        k8s_glog
                Format      regex
                Regex       ^(?<severity>[IWEF])(?<date>\d{4}) (?<time>\d{2}:\d{2}:\d{2}\.\d{6})\s+(?<thread_id>\d+)\s+(?<source_file>[^:]+):(?<line>\d+)\]\s*(?<message>.*)$
                Time_Key    time
                Time_Format %H:%M:%S.%L
                Time_Keep   On
          filters: |
            [FILTER]
                Name kubernetes
                Match kube.*
                Buffer_Size 1MB
                Merge_Log On
                Keep_Log Off
                K8S-Logging.Parser On
                K8S-Logging.Exclude On
                Owner_References on
                    
            [FILTER]
                Name                parser
                Match               kube.*
                Key_Name            log
                Parser              k8s_json
                Reserve_Data        On
                Preserve_Key        On

            [FILTER]
                Name                parser
                Match               kube.*
                Key_Name            log
                Parser              k8s_logfmt
                Reserve_Data        On
                Preserve_Key        On

            [FILTER]
                Name              parser
                Match             kube.*
                Key_Name          log
                Parser            k8s_glog
                Reserve_Data      On
                Preserve_Key      On
          outputs: |
            [OUTPUT]
                Name         opentelemetry
                Match        *
                Host         hyperdx-hdx-oss-v2-otel-collector.hyperdx.svc.cluster.local.
                Port         4317
                Grpc         on
                Header       authorization ee42ac01-9495-456e-adfc-9e81908e5d1f
                tls          off
                tls.verify   off
                logs_body_key log
                logs_body_key_attributes on
        hotReload:
          enabled: true
---
