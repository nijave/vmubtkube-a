apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: fluent-bit
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  destination:
    server: "https://kubernetes.default.svc"
    namespace: kube-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - PruneLast=true
    - ServerSideApply=true
    - ApplyOutOfSyncOnly=true
  source:
    chart: fluent-bit
    repoURL: https://fluent.github.io/helm-charts
    targetRevision: 0.49.1
    helm:
      releaseName: fluent-bit
      valuesObject:
        rbac:
          create: true
          nodeAccess: true
          eventsAccess: true
        serviceMonitor:
          enabled: true
          selector:
            release: prom
        prometheusRule:
          enabled: true
          additionalLabels:
            release: prom
          rules:
          - alert: NoOutputBytesProcessed
            expr: rate(fluentbit_output_proc_bytes_total[5m]) == 0
            annotations:
              message: |
                Fluent Bit instance {{ $labels.instance }}'s output plugin {{ $labels.name }} has not processed any
                bytes for at least 15 minutes.
              summary: No Output Bytes Processed
            for: 15m
        autoscaling:
          enabled: true
          vpa:
            enabled: true
        config:
          inputs: |
            [INPUT]
                Name tail
                Path /var/log/containers/*.log
                multiline.parser cri
                Tag kube.*
                Mem_Buf_Limit 8MB
                Skip_Long_Lines On
            [INPUT]
                Name systemd
                Tag host.*
                Systemd_Filter _SYSTEMD_UNIT=kubelet.service
                Read_From_Tail On
          filters: |
            [FILTER]
                Name kubernetes
                Match kube.*
                Buffer_Size 1MB
                Merge_Log On
                Keep_Log Off
                K8S-Logging.Parser On
                K8S-Logging.Exclude On
                Owner_References on
          outputs: |
            [OUTPUT]
                Name         opentelemetry
                Match        *
                Host         hyperdx-hdx-oss-v2-otel-collector.hyperdx.svc.cluster.local.
                Port         4317
                Grpc         on
                Header       authorization ee42ac01-9495-456e-adfc-9e81908e5d1f
                tls          off
                tls.verify   off
                logs_body_key log
                logs_body_key_attributes on
        hotReload:
          enabled: true
---
